---
title: "Exploration of NFHS death file"
author: Casey Breen
---


## Read in data 


```{r}
## library packages 
library(tidyverse)
library(haven)
library(cowplot)
library(here)


## read in death file 
death_file <- read_dta(here("data", "analysis_files", "nfhs5_deaths.DTA"))
```


## clean up variables 

- Each row corresponds to a death 
- Each column corresponds to a variable


variable definitions to recode: 

- hv024 = state of household (new var, state)
- shdist = district of household (new var, district)
- sh91_ = death_registration (new var, registered)
- hv001 = cluster number 
- hv005 = household weight 

other key variables (not recodes)

- death age = age of death 
- female = female gender 

```{r}
## death registration 
## 1 = registered and 0 = not registered
death_file <- death_file %>% 
  mutate(registered = case_when(
    sh91_ == 1 ~ "registered",
    sh91_ == 0 ~ "not registered"
  )) %>% 
  ## recode gender 
  mutate(gender = case_when(
    female == 1 ~ "women",
    TRUE ~ "men"
  )) %>% 
  ## rename variables 
  rename(
    state = hv024,
    district = shdist, 
    wealth_quantile =  hv270,
    rural_urban  = hv025,
    registered_dummy = sh91_
  )

```

## geography 



```{r}
## death registration by district 
death_registration_by_district <- death_file %>% 
  group_by(district) %>% 
  summarize(mean_death_registration = mean(registered_dummy))
  
district_plot <- death_registration_by_district %>% 
  ggplot() + 
  geom_histogram(aes(x = mean_death_registration), color = "black", fill = "grey") + 
  cowplot::theme_cowplot() + 
  labs(x = "Deaths Registered (%)", y = "Number of Districts") + 
  scale_x_continuous(labels = scales::percent_format())
```


```{r}
# Define burnt orange color
burnt_orange <- "#CC5500"

# Calculating mean death registration and standard error by state
death_registration_by_state <- death_file %>% 
  group_by(state) %>% 
  summarize(mean_death_registration = mean(registered_dummy),
            se_death_registration = sd(registered_dummy) / sqrt(n())) %>% 
  mutate(state = as_factor(state))

# Plotting with geom_linerange for 80% and 90% CI and geom_pointrange for 95% CI
state_plot <- death_registration_by_state %>% 
  ggplot() +
  # 90% CI (z = 1.645)
  geom_linerange(aes(x = mean_death_registration, 
                     y = reorder(state, mean_death_registration),
                     xmin = mean_death_registration - 1.645 * se_death_registration,
                     xmax = mean_death_registration + 1.645 * se_death_registration), 
                 color = burnt_orange, size = 1) +

  # 95% CI (z = 1.96)
  geom_pointrange(aes(x = mean_death_registration, 
                      y = reorder(state, mean_death_registration),
                      xmin = mean_death_registration - 1.96 * se_death_registration,
                      xmax = mean_death_registration + 1.96 * se_death_registration), 
                  color = burnt_orange, fill = burnt_orange, size = 1.5, fatten = 2.5) + #,  
  
  # Custom theme and labels
  cowplot::theme_cowplot() + 
  labs(x = "Deaths Registered (%)",
       y = "State") + 
  scale_x_continuous(labels = scales::percent_format(), limits = c(0, 1))
```


```{r}
age_plot <- death_file %>% 
  mutate(female_recode = case_when(
    female == 1 ~ "women",
    TRUE ~ "men"
  )) %>%
  group_by(death_age, female_recode) %>% 
  summarize(registered = mean(registered_dummy),
            se = sd(registered_dummy) / sqrt(n()-1)) %>% 
  ggplot(aes(x = death_age, y = registered, color = female_recode,
             ymin = registered - 1.96 * se, 
             ymax = registered + 1.96 * se, 
             )) +
  geom_pointrange(position = position_dodge(width = 0.4)) + 
  geom_line() + 
  ggsci::scale_color_lancet() +
  theme_cowplot() + 
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, 1)) +
  theme(legend.position = "bottom") + 
  labs(x = "Age of Death",
       y = "Death Registration (%)") + 
  guides(color = guide_legend(title = NULL))
```

```{r}
urban_plot <- death_file %>% 
  mutate(rural_urban = case_when(
    rural_urban == 2 ~ "rural",
    TRUE ~ "urban"
  )) %>%
  group_by(wealth_quantile, gender, rural_urban) %>% 
  summarize(registration = mean(registered_dummy)) %>% 
  ggplot(aes(x = wealth_quantile, y = registration)) + 
  geom_col(aes(fill = gender), color = "black", position = position_dodge2(1), alpha = 0.5) + 
  geom_text(aes(label = paste0(round(registration, 2)* 100, "%")), vjust = -0.5, position = position_dodge2(1)) + 
  ggsci::scale_fill_lancet() +
  theme_cowplot() + 
  scale_y_continuous(labels = scales::percent_format()) +
  theme(legend.position = "bottom") + 
  labs(x = "Wealth Quantile",
       y = "Death Registration (%)") + 
  facet_wrap(~rural_urban)
  
```

```{r}
plot_left <- cowplot::plot_grid(district_plot, urban_plot, age_plot, labels = "AUTO", cols = 1) 

full_plot <- cowplot::plot_grid(plot_left, state_plot, labels = c("", "D"), cols = 2, rel_widths = c(1.3, 1))

ggsave(full_plot, filename = here("figures", "death_registration.png"), width = 14, height = 14)
```


Other predictors: 

— Presence of educated family member
— Household size 
— Geospatial stuff
— Length of period between death and interview (months)
— Caste 
— Native language 
— Number of children under 5
— Marital status 
— Mode of transport 
— Exposure to media and literacy 
— Household member disability 
— District level covariates - district wealth, district mortality, education, etc. etc. 
— Variables for health care access 
— Digital variables - internet access, mobile phone access, etc. 


```{r}
summary(model)
```


```{r}
set.seed(123)  # Setting seed for reproducibility

# Create a random split indicator
split <- sample(1:nrow(death_file), size = 0.7 * nrow(death_file))

# Split the data into training and test sets
training_sample <- death_file[split, ]
test_sample <- death_file[-split, ]
```


```{r}
model <- glm(sh91_ ~ death_age + female + as.factor(hv270) + as.factor(hv025) + as.factor(hv024), data = training_sample, family = "binomial")

predict(model, newdata = test_sample, type = "response")

test_sample %>% 
  mutate(prediction = predict(model, newdata = test_sample, type = "response")) %>% 
  mutate(prediction_binary = case_when(
    prediction > 0.5 ~ 1,
    TRUE ~ 0
  )) %>% 
  count(sh91_, prediction_binary)
```


